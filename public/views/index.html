<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Guides</title>
	<meta name="viewport" content="initial-scale=1,maximum-scale=1">
	<!-- MAPBOX -->
	<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script> <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<!-- FONT AWESOME -->
	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
	/>
	<link rel="stylesheet" href="css/index.css">
	<style>
        .collapse-date-time {
            position: absolute;
            z-index: 3;
            margin-top: 7px;
            left: 82%;
            width: 300px;
        }
		.input-group .form-control {
            width: 100%;
        }
		
		.real-time-input {
            position: fixed;
			width: 300px;
            left: 84%;
			bottom: 4%;
            z-index: 4;
        }
	</style>
</head>
<body>
	<!-------------------------- HEADER ---------------------------------->
	<header class="p-3 bg-dark text-white">
		<div class="container-fluid border-col">
			<div
				class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start"
			>
				<a
					href="/"
					class="d-flex align-items-center mb-2 mb-lg-0 text-white text-decoration-none"
				>
					<svg
						class="bi me-2"
						width="40"
						height="32"
						role="img"
						aria-label="Bootstrap"
					>
						<use xlink:href="#bootstrap"></use>
					</svg>
				</a>

				<ul
					class="nav col-12 col-lg-auto col-md-8 col-sm-6 me-lg-auto mb-2 justify-content-center mb-md-0"
				>
					<li>
						<a href="#" class="nav-link px-2 text-secondary text-white">
							<!--
							<img
								id="map_icon"
								class="img-fluid;"
								src="{% static 'img/logo.png' %}"
								height="40px"
								/> -->
							Gloria 2
						</a>
					</li>
				</ul>
				<div class="text-end">
					<div class="flex-shrink-0 dropdown">
						<a
							class="nav-link dropdown-toggle"
							href="#"
							id="dropdown06"
							data-bs-toggle="dropdown"
							aria-expanded="true"
						>
							<i class="fa fa-angle-down" style="color: white"></i>
						</a>
						<ul
							class="dropdown-menu"
							aria-labelledby="dropdown06"
							data-bs-popper="static"
						>
							<li>
								<a class="dropdown-item" href="{% url 'index' %}">Página principal</a>
							</li>
							
						</ul>
					</div>
				</div>
			</div>
		</div>
	</header>
	<!--------------- BOTON DE BÚSQUEDAD POR FECHA ----------------------------------->
	<div class="container">
		<button
			class="btn btn-primary"
			type="button"
			style="position: absolute; z-index: 2; left: 97.5%; margin-top: 5px; margin-right: 10px;"
			data-bs-toggle="collapse"
			data-bs-target="#fechaCollapse"
			aria-expanded="true"
			aria-controls="fechaCollapse"
		>
			<i class="fa fa-search"></i>
		</button>
		<!-- Campo de entrada de fecha colapsable -->
		<div class="collapse collapse-date-time" id="fechaCollapse" style="position: absolute; z-index: 3; margin-top: 7px; left:81%">
            <!-- Creamos un form con un input de tipo fecha y un calendario-->
            <form action="http://localhost:8080/" method="POST" class="p-3 bg-light text-black rounded">
                <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon1"><i class="fa fa-calendar"></i></span>
                    <input type="date" name="fecha" id="fecha" class="form-control" placeholder="Select Date" aria-label="Fecha" aria-describedby="basic-addon1">
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon2"><i class="fa fa-clock-o"></i></span>
                    <input type="time" name="hora" id="hora" class="form-control" placeholder="Select Time" aria-label="Hora" aria-describedby="basic-addon2">
                </div>
                <button type="submit" class="btn btn-primary w-100">Buscar</button>
            </form>
        </div>
		<div class="real-time-input bg-light text-dark p-3 rounded">
			<div id="fechaDisplay"></div>
            <div id="horaDisplay"></div>
        </div>
		<div>
				<!--------- PANEL LATERAL --------------- -->

			<button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample" style="posItion:fixed; top:50%; left: 20px;z-index: 4;">
				<i class="fa fa-bars"></i>
			</button>
		
		  <div class="offcanvas offcanvas-start text-white bg-dark" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
			  <div class="offcanvas-header">
			  <h5 class="offcanvas-title" id="offcanvasExampleLabel">Piscifactoría</h5>
			  <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
			  </div>
			  <div class="offcanvas-body">
				<img class="img-fluid rounded" style="padding-bottom: 20px;" src="https://i0.wp.com/aliolitoursalicante.com/wp-content/uploads/2016/11/la-lonja-el-campello-1.jpg?w=780&ssl=1">
				<div class="list-group scrollarea">
					<div class="list-group-item lateral-list" id="lonja-id"><b>Lonja: </b>Campello</div>
					<div class="list-group-item lateral-list" id="oleaje-id"><b>Altitud oleaje(m): </b>3.4</div>
					<div class="list-group-item lateral-list" id="temperatura-id"><b>Temperatura: </b>27ºC</div>
					<div class="list-group-item lateral-list" id="sensterm-id"><b>Sensación térmica: </b>29ºC</div>
					<div class="list-group-item lateral-list" id="viento-id"><b>Viento: </b>3.2km/h</div>
					<div class="list-group-item lateral-list" id="dirviento-id"><b>Dirección del viento:</b> Sudoeste</div>
					<div class="list-group-item lateral-list" id="visibilidad-id"><b>Visibilidad:</b> claro</div>
					<div class="list-group-item lateral-list" id="presionatm-id"><b>Presión atomsférica:</b>11</div>
					<div class="list-group-item lateral-list" id="nubes-id"><b>Nubes:</b>11</div>
					<div class="list-group-item lateral-list alert alert-danger text-white" id="riesgo-id" style="background-color: #842029;"><b>Riesgo de escape: </b><span>Alto</span></div>
				</div>
			  </div>
		  </div>
	  </div>
	</div>

	<div id="map" style="box-sizing: content-box; margin-top: 72px; z-index: 1"></div> 
	<div id="data_lonja" hidden><%= data %></div>
	<div id="data_fish_farm" hidden><%= data_fish_farm %></div>
	<div id="hora_data" hidden><%= hora  %></div>
	<div id="fecha_data" hidden><%= fecha %></div>
	<script>
		document.getElementById("fechaDisplay").innerText = 'Fecha: ' + document.getElementById("fecha_data").textContent;
		document.getElementById("horaDisplay").innerText = 'Hora seleccionada: ' + document.getElementById("hora_data").textContent;
	</script>
	<script>
		const data = JSON.parse(document.getElementById("data_lonja").textContent);
		const data_fish_farm = JSON.parse(document.getElementById("data_fish_farm").textContent);	
		console.log(data_fish_farm);

		mapboxgl.accessToken = 'pk.eyJ1Ijoic2ViYXMtcCIsImEiOiJjbHMxbzk1ZmYwYjlwMmpwY3hxdDl2amlhIn0.1J2kKRWx_t2PKcuPUGZbFg';
			const map = new mapboxgl.Map({
					container: 'map',
					style: 'mapbox://styles/mapbox/dark-v11',
					projection: 'globe', // Display the map as a globe, since satellite-v9 defaults to Mercator
					zoom: 8,
					center: [-0.42935695580101674, 38.34080182349807]
			});

		map.on("load", () => {
			map.addSource("lonjas", {
				type : "geojson",
				data : data,
			})

			map.addSource("fish-farm", {
				type : "geojson",
				data : data_fish_farm,
			})

			map.addLayer(
				{
					'id' : "lonjas",
					'type' : "circle",
					'source' : "lonjas",
					'paint' : {
						'circle-radius' : 5,
						'circle-color' : '#d9ef9f',
						'circle-opacity' : 0.5,
					}
				}
			)

			map.addLayer(
				{
					'id': "fish-farm-polygon",
					'type': "fill",
					'source': "fish-farm",
					'paint': {
						"fill-opacity" : 0.5,
						"fill-color" : [
							"interpolate",
							["linear"],
							["get", "wave_hour"],
							0,
							"#ffffff",
							0.5,
							"#20a7ad", 
							1,
							"#85bb5b", // Verde
							1.5,
							"#ffa827",
							2,
							"#ff8400", 
							2.5,
							"#e85129",
							3,
							"#ff0000",
						]	
					}
				})
		});

		map.on('click', (event) => {
			const features = map.queryRenderedFeatures(event.point, {
				layers: ['fish-farm-polygon']
			});

			if(!features.length) {
				return;
			}

			const feature = features[0];

			//document.getElementById("lonja-id").innerHTML = `<b>Lonja: </b>${ feature.properties.lonja }`
			document.getElementById("lonja-id").innerHTML = `<b>Lonja: </b>Campello`
			document.getElementById("oleaje-id").innerHTML = `<b>Altitud oleaje(m): </b>${ feature.properties.wave_hour }`
			document.getElementById("temperatura-id").innerHTML = `<b>Temperatura: </b>${ feature.properties.temp }ºC`
			document.getElementById("sensterm-id").innerHTML = `<b>Sensación térmica: </b>${ feature.properties.feels_like }ºC`
			document.getElementById("viento-id").innerHTML = `<b>Viento: </b>${ feature.properties.wind_speed }km/h`
			document.getElementById("dirviento-id").innerHTML = `<b>Dirección del viento:</b> ${ feature.properties.wind_deg }`
			document.getElementById("visibilidad-id").innerHTML = `<b>Visibilidad:</b> ${ feature.properties.visibility }`
			document.getElementById("presionatm-id").innerHTML = `<b>Presión atomsférica:</b>${ feature.properties.pressure }`
			document.getElementById("nubes-id").innerHTML = `<b>Nubes:</b>${ feature.properties.clouds }`
			if(feature.properties.wave_hour > 2) {
				document.getElementById("riesgo-id").innerHTML = `<b>Riesgo de escape: </b><span>Alto</span>`
				document.getElementById("riesgo-id").style.backgroundColor = "#842029"
			} else if(feature.properties.wave_hour > 1) {
				document.getElementById("riesgo-id").innerHTML = `<b>Riesgo de escape: </b><span>Medio</span>`
				document.getElementById("riesgo-id").style.backgroundColor = "#f0ad4e"
			} else {
				document.getElementById("riesgo-id").innerHTML = `<b>Riesgo de escape: </b><span>Bajo</span>`
				document.getElementById("riesgo-id").style.backgroundColor = "#5cb85c"
			}

			
			var wave = feature.properties.wave_hour;
			var array_center = feature.properties.center.slice(1, feature.properties.center.length-1).split(",")
			var lng_lat = new mapboxgl.LngLat(array_center[0], array_center[1])
			const popup = new mapboxgl.Popup({ offset: [0, -15] })
				.setLngLat(lng_lat)
				.setHTML(
					`<h3>${ wave }</h3>`
				)
				.addTo(map);
		});
	</script>
</body>
</html>
